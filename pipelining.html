<!DOCTYPE html><html><head><title>Valkey4Cats: Pipelining</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="ProfunKtor" /><meta name="description" content="Valkey client for Cats Effect &amp; Fs2" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="Valkey4Cats: Pipelining" /><meta name="title" property="og:title" content="Valkey4Cats: Pipelining" /><meta name="og:site_name" content="Valkey4Cats" /><meta name="og:url" content="https://valkey.profunktor.dev/" /><meta name="og:type" content="website" /><meta name="og:description" content="Valkey client for Cats Effect &amp; Fs2" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Valkey4Cats: Pipelining" /><meta name="twitter:image" content="/img/poster.png" /><meta name="twitter:description" content="Valkey client for Cats Effect &amp; Fs2" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/vs.css" /><link rel="stylesheet" href="/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"></div><span>Valkey4Cats</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/quickstart.html" title="Quick Start" class="">Quick Start</a></div> <div class="sidebar-nav-item  "><a href="/client.html" title="Client" class="">Client</a></div> <div class="sidebar-nav-item  "><a href="/codecs.html" title="Codecs" class="">Codecs</a></div> <div class="sidebar-nav-item  "><a href="/effects/" title="Effects API" class="drop-nested">Effects API</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/effects/bitmaps.html" title="Bitmaps" class="">Bitmaps</a> <a href="/effects/connection.html" title="Connection" class="">Connection</a> <a href="/effects/geo.html" title="Geo" class="">Geo</a> <a href="/effects/hashes.html" title="Hashes" class="">Hashes</a> <a href="/effects/keys.html" title="Keys" class="">Keys</a> <a href="/effects/lists.html" title="Lists" class="">Lists</a> <a href="/effects/scripting.html" title="Scripting" class="">Scripting</a> <a href="/effects/server.html" title="Server" class="">Server</a> <a href="/effects/sets.html" title="Sets" class="">Sets</a> <a href="/effects/sortedsets.html" title="Sorted Sets" class="">Sorted Sets</a> <a href="/effects/strings.html" title="Strings" class="">Strings</a></div></div> <div class="sidebar-nav-item  "><a href="/streams/" title="Streams API" class="drop-nested">Streams API</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/streams/pubsub.html" title="PubSub" class="">PubSub</a> <a href="/streams/streams.html" title="Streams" class="">Streams</a></div></div> <div class="sidebar-nav-item  "><a href="/transactions.html" title="Transactions" class="">Transactions</a></div> <div class="sidebar-nav-item active "><a href="/pipelining.html" title="Pipelining" class="active">Pipelining</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/profunktor/valkey4cats" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/profunktor/valkey4cats" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="profunktor" data-github-repo="valkey4cats"><div class="content-wrapper"><section><h1 id="pipelining">Pipelining</h1>

<p>Use <a href="https://redis.io/topics/pipelining">pipelining</a> to speed up your queries by having full control of commands flushing. By default Redis works in autoflush mode but it can be disabled to “pipeline” commands to the server without waiting for a response. And at any point in time you can “flush commands”.</p>

<p><code class="language-plaintext highlighter-rouge">RedisCommands</code> provides two methods: <code class="language-plaintext highlighter-rouge">pipeline</code> and <code class="language-plaintext highlighter-rouge">pipeline_</code>, which are very similar to the transactional commands (see <a href="./transactions.html">Transactions</a>). The behavior is modeled as a resource described below:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">acquire</code>: disable autoflush and send a bunch of commands defined as a <code class="language-plaintext highlighter-rouge">List[F[Unit]]</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">release</code>: either flush commands on success or log error on failure / cancellation.</li>
  <li><code class="language-plaintext highlighter-rouge">guarantee</code>: re-enable autoflush.</li>
</ul>

<p>⚠️ <strong>Pipelining shares the same asynchronous implementation of transactions, so you can only run sequential pipelines from a single <code class="language-plaintext highlighter-rouge">RedisCommands</code> instance.</strong> ⚠️</p>

<h3 id="redispipeline-usage">RedisPipeline usage</h3>

<p>The API for disabling / enabling autoflush and flush commands manually is available for you to use but since the pattern is so common it is recommended to use <code class="language-plaintext highlighter-rouge">RedisPipe</code>, because it shares the same implementation of <code class="language-plaintext highlighter-rouge">RedisTx</code>, which can be tricky to get right.</p>

<p>Note that every command has to be forked (<code class="language-plaintext highlighter-rouge">.start</code>) because the commands need to be sent to the server in an asynchronous way but no response will be received until the commands are successfully flushed. Also, it is not possible to sequence commands (<code class="language-plaintext highlighter-rouge">flatMap</code>) that are part of a pipeline. Every command has to be atomic and independent of previous results.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">dev.profunktor.redis4cats._</span>
<span class="k">import</span> <span class="nn">dev.profunktor.redis4cats.tx.TxStore</span>

<span class="k">val</span> <span class="nv">key1</span> <span class="k">=</span> <span class="s">"testp1"</span>
<span class="k">val</span> <span class="nv">key2</span> <span class="k">=</span> <span class="s">"testp2"</span>
<span class="k">val</span> <span class="nv">key3</span> <span class="k">=</span> <span class="s">"testp3"</span>

<span class="k">val</span> <span class="nv">showResult</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">key</span> <span class="k">=&gt;</span>
  <span class="nv">_</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span><span class="nv">IO</span><span class="o">.</span><span class="py">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Not found key: $key"</span><span class="o">))(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$key: $s"</span><span class="o">))</span>

<span class="nv">commandsApi</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">redis</span> <span class="k">=&gt;</span> <span class="c1">// RedisCommands[IO, String, String]</span>
  <span class="k">val</span> <span class="nv">getters</span> <span class="k">=</span>
    <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key1</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key1</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
        <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key2</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
        <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key3</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key3</span><span class="o">))</span>

  <span class="k">val</span> <span class="nv">ops</span> <span class="k">=</span> <span class="o">(</span><span class="n">store</span><span class="k">:</span> <span class="kt">TxStore</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">String</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span> <span class="k">=&gt;</span>
    <span class="nc">List</span><span class="o">(</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="s">"osx"</span><span class="o">),</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key3</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">store</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key3</span><span class="o">)),</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="s">"linux"</span><span class="o">)</span>
    <span class="o">)</span>

  <span class="k">val</span> <span class="nv">runPipeline</span> <span class="k">=</span>
    <span class="nv">redis</span><span class="o">.</span><span class="py">pipeline</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">kv</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">println</span><span class="o">(</span><span class="n">s</span><span class="s">"KV: $kv"</span><span class="o">))</span>
      <span class="o">.</span><span class="py">recoverWith</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">e</span> <span class="k">=&gt;</span>
          <span class="nv">IO</span><span class="o">.</span><span class="py">println</span><span class="o">(</span><span class="n">s</span><span class="s">"[Error] - ${e.getMessage}"</span><span class="o">)</span>
      <span class="o">}</span>

  <span class="k">val</span> <span class="nv">prog</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span>  <span class="k">&lt;-</span> <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key3</span><span class="o">,</span> <span class="s">"3"</span><span class="o">)</span>
      <span class="k">_</span>  <span class="k">&lt;-</span> <span class="n">runPipeline</span>
      <span class="n">v1</span> <span class="k">&lt;-</span> <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key1</span><span class="o">)</span>
      <span class="n">v2</span> <span class="k">&lt;-</span> <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
      <span class="nf">assert</span><span class="o">(</span><span class="nv">v1</span><span class="o">.</span><span class="py">contains</span><span class="o">(</span><span class="s">"osx"</span><span class="o">))</span>
      <span class="nf">assert</span><span class="o">(</span><span class="nv">v2</span><span class="o">.</span><span class="py">contains</span><span class="o">(</span><span class="s">"linux"</span><span class="o">))</span>
    <span class="o">}</span>

  <span class="n">getters</span> <span class="o">&gt;&gt;</span> <span class="n">prog</span> <span class="o">&gt;&gt;</span> <span class="n">getters</span> <span class="o">&gt;&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">println</span><span class="o">(</span><span class="s">"keep doing stuff..."</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">pipeline</code> method provides a <code class="language-plaintext highlighter-rouge">TxStore</code> we can use to store values we run within the pipeline for later retrieval, same as we do with transactions. If you don’t need the store, prefer to use <code class="language-plaintext highlighter-rouge">pipeline_</code> instead.</p>
</section></div></div></div></div><script src="/highlight/highlight.pack.js"></script><script src="/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'profunktor-dev/valkey4cats'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/search.js"></script><script src="/js/docs.js"></script></body></html>