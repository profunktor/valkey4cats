<!DOCTYPE html><html><head><title>Valkey4Cats: Transactions</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="ProfunKtor" /><meta name="description" content="Valkey client for Cats Effect &amp; Fs2" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="Valkey4Cats: Transactions" /><meta name="title" property="og:title" content="Valkey4Cats: Transactions" /><meta name="og:site_name" content="Valkey4Cats" /><meta name="og:url" content="https://valkey.profunktor.dev/" /><meta name="og:type" content="website" /><meta name="og:description" content="Valkey client for Cats Effect &amp; Fs2" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Valkey4Cats: Transactions" /><meta name="twitter:image" content="/img/poster.png" /><meta name="twitter:description" content="Valkey client for Cats Effect &amp; Fs2" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/vs.css" /><link rel="stylesheet" href="/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"></div><span>Valkey4Cats</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/quickstart.html" title="Quick Start" class="">Quick Start</a></div> <div class="sidebar-nav-item  "><a href="/client.html" title="Client" class="">Client</a></div> <div class="sidebar-nav-item  "><a href="/codecs.html" title="Codecs" class="">Codecs</a></div> <div class="sidebar-nav-item  "><a href="/effects/" title="Effects API" class="drop-nested">Effects API</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/effects/bitmaps.html" title="Bitmaps" class="">Bitmaps</a> <a href="/effects/connection.html" title="Connection" class="">Connection</a> <a href="/effects/geo.html" title="Geo" class="">Geo</a> <a href="/effects/hashes.html" title="Hashes" class="">Hashes</a> <a href="/effects/keys.html" title="Keys" class="">Keys</a> <a href="/effects/lists.html" title="Lists" class="">Lists</a> <a href="/effects/scripting.html" title="Scripting" class="">Scripting</a> <a href="/effects/server.html" title="Server" class="">Server</a> <a href="/effects/sets.html" title="Sets" class="">Sets</a> <a href="/effects/sortedsets.html" title="Sorted Sets" class="">Sorted Sets</a> <a href="/effects/strings.html" title="Strings" class="">Strings</a></div></div> <div class="sidebar-nav-item  "><a href="/streams/" title="Streams API" class="drop-nested">Streams API</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/streams/pubsub.html" title="PubSub" class="">PubSub</a> <a href="/streams/streams.html" title="Streams" class="">Streams</a></div></div> <div class="sidebar-nav-item active "><a href="/transactions.html" title="Transactions" class="active">Transactions</a></div> <div class="sidebar-nav-item  "><a href="/pipelining.html" title="Pipelining" class="">Pipelining</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/profunktor/valkey4cats" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/profunktor/valkey4cats" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="profunktor" data-github-repo="valkey4cats"><div class="content-wrapper"><section><h1 id="transactions">Transactions</h1>

<p>Redis supports <a href="https://redis.io/topics/transactions">transactions</a> via the <code class="language-plaintext highlighter-rouge">MULTI</code>, <code class="language-plaintext highlighter-rouge">EXEC</code> and <code class="language-plaintext highlighter-rouge">DISCARD</code> commands. <code class="language-plaintext highlighter-rouge">redis4cats</code> provides a <code class="language-plaintext highlighter-rouge">RedisTx</code> utility that models a transaction as a <code class="language-plaintext highlighter-rouge">Resource</code>.</p>

<h2 id="caveats">Caveats</h2>

<p>Note that every command has to be forked (<code class="language-plaintext highlighter-rouge">.start</code>) because the commands need to be sent to the server asynchronously and no response will be received until either an <code class="language-plaintext highlighter-rouge">EXEC</code> or a <code class="language-plaintext highlighter-rouge">DISCARD</code> command is sent. Both forking and sending the final command is handled by <code class="language-plaintext highlighter-rouge">RedisTx</code>.</p>

<p>These are internals, though. All you need to care about is what commands you want to run as part of a transaction and handle the possible errors and retry logic.</p>

<h5 id="concurrent-transactions">Concurrent transactions</h5>

<p>⚠️ in order to run transactions concurrently, you’d need to acquire a connection per transaction (<code class="language-plaintext highlighter-rouge">RedisCommands</code>), as <code class="language-plaintext highlighter-rouge">MULTI</code> can not be called concurrently within the same connection. For such cases, it is recommended to share the same <code class="language-plaintext highlighter-rouge">RedisClient</code>. ⚠️</p>

<h3 id="working-with-transactions">Working with transactions</h3>

<p>There are two methods available in <code class="language-plaintext highlighter-rouge">RedisCommands</code>: <code class="language-plaintext highlighter-rouge">transact</code> and <code class="language-plaintext highlighter-rouge">transact_</code>. The former takes a function <code class="language-plaintext highlighter-rouge">TxStore[F, K, V] =&gt; List[F[Unit]]</code> whereas the latter only takes a <code class="language-plaintext highlighter-rouge">List[F[Unit]]</code>.</p>

<p><code class="language-plaintext highlighter-rouge">TxStore</code> provides a way to store transactional values for later retrieval, as we cannot chain transactional together via <code class="language-plaintext highlighter-rouge">flatMap</code> and friends (every command needs to be atomic and independent of previous Redis results).</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">TxStore</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">K</span>, <span class="kt">V</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">get</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">K</span>, <span class="kt">V</span><span class="o">]]</span>
  <span class="k">def</span> <span class="nf">set</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">K</span><span class="o">)(</span><span class="n">v</span><span class="k">:</span> <span class="kt">V</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">List[F[Unit]]</code> represents a list of Redis operations you wish to run within a transaction, ordered from left to right.</p>

<p>Below you can find a first example of transactional commands.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">dev.profunktor.redis4cats._</span>
<span class="k">import</span> <span class="nn">dev.profunktor.redis4cats.tx.</span><span class="o">{</span> <span class="nc">TransactionDiscarded</span><span class="o">,</span> <span class="nc">TxStore</span> <span class="o">}</span>

<span class="k">val</span> <span class="nv">key1</span> <span class="k">=</span> <span class="s">"test1"</span>
<span class="k">val</span> <span class="nv">key2</span> <span class="k">=</span> <span class="s">"test2"</span>
<span class="k">val</span> <span class="nv">key3</span> <span class="k">=</span> <span class="s">"test3"</span>

<span class="k">val</span> <span class="nv">showResult</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">key</span> <span class="k">=&gt;</span>
  <span class="nv">_</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span><span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Key not found: $key"</span><span class="o">))(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"$key: $s"</span><span class="o">))</span>

<span class="nv">commandsApi</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">redis</span> <span class="k">=&gt;</span> <span class="c1">// RedisCommands[IO, String, String]</span>
  <span class="k">val</span> <span class="nv">setters</span> <span class="k">=</span> <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="s">"delete_me"</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key3</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">)</span>

  <span class="k">val</span> <span class="nv">getters</span> <span class="k">=</span>
    <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key1</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key1</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key2</span><span class="o">))</span>

  <span class="k">val</span> <span class="nv">ops</span> <span class="k">=</span> <span class="o">(</span><span class="n">store</span><span class="k">:</span> <span class="kt">TxStore</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">String</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span> <span class="k">=&gt;</span>
    <span class="nc">List</span><span class="o">(</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">),</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">del</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">void</span><span class="o">,</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key3</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">store</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key3</span><span class="o">))</span>
    <span class="o">)</span>

  <span class="k">val</span> <span class="nv">prog</span> <span class="k">=</span>
    <span class="nv">redis</span><span class="o">.</span><span class="py">transact</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span>
      <span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">kv</span> <span class="k">=&gt;</span>
        <span class="nv">IO</span><span class="o">.</span><span class="py">println</span><span class="o">(</span><span class="n">s</span><span class="s">"KV: ${kv}"</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="py">recoverWith</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">TransactionDiscarded</span> <span class="k">=&gt;</span>
          <span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">error</span><span class="o">(</span><span class="s">"[Error] - Transaction Discarded"</span><span class="o">)</span>
        <span class="k">case</span> <span class="n">e</span> <span class="k">=&gt;</span>
          <span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">error</span><span class="o">(</span><span class="n">s</span><span class="s">"[Error] - $e"</span><span class="o">)</span>
      <span class="o">}</span>

  <span class="n">setters</span> <span class="o">&gt;&gt;</span> <span class="n">getters</span> <span class="o">&gt;&gt;</span> <span class="n">prog</span> <span class="o">&gt;&gt;</span> <span class="nv">getters</span><span class="o">.</span><span class="py">void</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It should be exclusively used to run Redis commands as part of a transaction, not any other computations. Fail to do so, may result in unexpected behavior.</p>

<p>Transactional commands may be discarded if something went wrong in between.</p>

<p>The <code class="language-plaintext highlighter-rouge">transact</code> method returns the values stored in the given <code class="language-plaintext highlighter-rouge">TxStore</code>, which is used to save results of commands that run as part of the transaction for later retrieval.</p>

<p>If you are only writing values (e.g. only using <code class="language-plaintext highlighter-rouge">set</code>), you may prefer to use <code class="language-plaintext highlighter-rouge">transact_</code> instead.</p>

<h3 id="how-not-to-use-transactions">How NOT to use transactions</h3>

<p>For example, the following transaction will result in a dead-lock:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">commandsApi</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">redis</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="nv">getters</span> <span class="k">=</span>
    <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key1</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key1</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key2</span><span class="o">))</span>

  <span class="k">val</span> <span class="nv">setters</span> <span class="k">=</span> <span class="nv">redis</span><span class="o">.</span><span class="py">transact_</span><span class="o">(</span>
    <span class="nc">List</span><span class="o">(</span><span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">),</span> <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">),</span> <span class="nv">redis</span><span class="o">.</span><span class="py">discard</span><span class="o">)</span>
  <span class="o">)</span>

  <span class="n">getters</span> <span class="o">*&gt;</span> <span class="nv">setters</span><span class="o">.</span><span class="py">void</span> <span class="o">*&gt;</span> <span class="nv">getters</span><span class="o">.</span><span class="py">void</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You should never pass a transactional command: <code class="language-plaintext highlighter-rouge">MULTI</code>, <code class="language-plaintext highlighter-rouge">EXEC</code> or <code class="language-plaintext highlighter-rouge">DISCARD</code>. These commands are made available in case you want to handle transactions manually, which you should do <em>at your own risk</em>.</p>

<p>The following example will result in a successful transaction on Redis. Yet, the operation will end up raising the error passed as a command.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">commandsApi</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">redis</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="nv">getters</span> <span class="k">=</span>
    <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key1</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key1</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key2</span><span class="o">))</span>

  <span class="k">val</span> <span class="nv">failedTx</span> <span class="k">=</span> <span class="nv">redis</span><span class="o">.</span><span class="py">transact_</span><span class="o">(</span>
    <span class="nc">List</span><span class="o">(</span><span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">),</span> <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">),</span> <span class="nv">IO</span><span class="o">.</span><span class="py">raiseError</span><span class="o">(</span><span class="k">new</span> <span class="nc">Exception</span><span class="o">(</span><span class="s">"boom"</span><span class="o">)))</span>
  <span class="o">)</span>

  <span class="n">getters</span> <span class="o">*&gt;</span> <span class="nv">failedTx</span><span class="o">.</span><span class="py">void</span> <span class="o">*&gt;</span> <span class="nv">getters</span><span class="o">.</span><span class="py">void</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="optimistic-locking">Optimistic locking</h3>

<p>Redis provides a mechanism called <a href="https://redis.io/topics/transactions#optimistic-locking-using-check-and-set">optimistic locking using check-and-set</a> via the <code class="language-plaintext highlighter-rouge">WATCH</code> command. Quoting the Redis documentation:</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">WATCH</code>ed keys are monitored in order to detect changes against them. If at least one watched key is modified before the <code class="language-plaintext highlighter-rouge">EXEC</code> command, the whole transaction aborts, and <code class="language-plaintext highlighter-rouge">EXEC</code> returns a <code class="language-plaintext highlighter-rouge">Null</code> reply to notify that the transaction failed.</p>
</blockquote>

<p>This library translates the <code class="language-plaintext highlighter-rouge">Null</code> reply as a <code class="language-plaintext highlighter-rouge">TransactionDiscarded</code> error raised in the effect type. E.g.:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">mkRedis</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">RedisCommands</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">String</span>, <span class="kt">String</span><span class="o">]]</span> <span class="k">=</span>
  <span class="nc">RedisClient</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">from</span><span class="o">(</span><span class="s">"redis://localhost"</span><span class="o">).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">cli</span> <span class="k">=&gt;</span>
    <span class="nc">Redis</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">fromClient</span><span class="o">(</span><span class="n">cli</span><span class="o">,</span> <span class="nv">RedisCodec</span><span class="o">.</span><span class="py">Utf8</span><span class="o">)</span>
  <span class="o">}</span>

<span class="k">def</span> <span class="nf">txProgram</span><span class="o">(</span><span class="n">v1</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">v2</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
  <span class="nv">mkRedis</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">redis</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">getters</span> <span class="k">=</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key1</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key1</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
        <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key2</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
        <span class="nv">redis</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key2</span><span class="o">).</span><span class="py">flatTap</span><span class="o">(</span><span class="nf">showResult</span><span class="o">(</span><span class="n">key3</span><span class="o">))</span>

    <span class="k">val</span> <span class="nv">ops</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="n">v1</span><span class="o">),</span> <span class="nv">redis</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="n">v2</span><span class="o">))</span>

    <span class="k">val</span> <span class="nv">prog</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nv">redis</span><span class="o">.</span><span class="py">transact_</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span>
        <span class="o">.</span><span class="py">onError</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">TransactionDiscarded</span> <span class="k">=&gt;</span>
            <span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">error</span><span class="o">(</span><span class="s">"[Error] - Transaction Discarded"</span><span class="o">)</span>
          <span class="k">case</span> <span class="n">e</span> <span class="k">=&gt;</span>
            <span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">error</span><span class="o">(</span><span class="n">s</span><span class="s">"[Error] - $e"</span><span class="o">)</span>
        <span class="o">}</span>

    <span class="k">val</span> <span class="nv">watching</span> <span class="k">=</span> <span class="nv">redis</span><span class="o">.</span><span class="py">watch</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="n">key2</span><span class="o">)</span>

    <span class="n">getters</span> <span class="o">&gt;&gt;</span> <span class="n">watching</span> <span class="o">&gt;&gt;</span> <span class="n">prog</span> <span class="o">&gt;&gt;</span> <span class="n">getters</span> <span class="o">&gt;&gt;</span> <span class="nc">Log</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">info</span><span class="o">(</span><span class="s">"keep doing stuff..."</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>Before executing the transaction, we invoke <code class="language-plaintext highlighter-rouge">redis.watch(key1, key2)</code>. Next, let’s run two concurrent transactions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IO</span><span class="o">.</span><span class="py">race</span><span class="o">(</span><span class="nf">txProgram</span><span class="o">(</span><span class="s">"osx"</span><span class="o">,</span> <span class="s">"linux"</span><span class="o">),</span> <span class="nf">txProgram</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)).</span><span class="py">void</span>
</code></pre></div></div>

<p>In this case, only the first transaction will be successful. The second one will be discarded. However, we want to eventually succeed most of the time, in which case we can retry a transaction until it succeeds (optimistic locking).</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">retriableTx</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nf">txProgram</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">).</span><span class="py">recoverWith</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">TransactionDiscarded</span> <span class="k">=&gt;</span> <span class="n">retriableTx</span>
  <span class="o">}.</span><span class="py">uncancelable</span>

<span class="nv">IO</span><span class="o">.</span><span class="py">race</span><span class="o">(</span><span class="nf">txProgram</span><span class="o">(</span><span class="s">"nix"</span><span class="o">,</span> <span class="s">"guix"</span><span class="o">),</span> <span class="n">retriableTx</span><span class="o">).</span><span class="py">void</span>
</code></pre></div></div>

<p>The first transaction will be successful, but ultimately, the second transaction will retry and set the values “foo” and “bar”.</p>

<p>All these examples can be found under <a href="https://github.com/profunktor/redis4cats/blob/master/modules/examples/src/main/scala/dev/profunktor/redis4cats/RedisTxDemo.scala">RedisTxDemo</a>.</p>
</section></div></div></div></div><script src="/highlight/highlight.pack.js"></script><script src="/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'profunktor-dev/valkey4cats'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/search.js"></script><script src="/js/docs.js"></script></body></html>